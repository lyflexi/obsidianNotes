无论是微服务中各个子系统相互之间的调用，还是客户端对服务端的调用，都存在网络延迟等问题，会导致重复请求接口，这时候接口就需要支持幂等性，来防止系统出现问题。比如重复调用支付接口会导致多次扣钱，重复调用订单接口会导致订单多次创建。接口的幂等性体现在写操作唯一和读操作返回结果唯一：

- 重复的写操作必须保证操作只执行一次
    
- 重复的读操作必须保证返回同一个结果
    

幂等性的解决有以下方案：

# 业务表创建唯一索引：最常用

对于数据插入的场景来说，这是最常见的方案。

核心业务字段设置为唯一索引，多次插入就会报错，从而保证幂等性。

# 支付状态位State

增加支付状态，0代表待支付 ， 1代表支付中 ， 2代表支付成功，3代表支付失败

SQL语句通过查询并重设状态位State值来保证支付幂等

```sql
update order set status = 1 where status =0 and orderId = “201251487987”
```

- SQL返回影响数 1 代表修改成功，可以支付，继续执行支付业务代码
    
- SQL返回影响数 0 代表修改失败，该订单已经不是待支付订单了。
    

# 记录版本号version

在业务表中新建一个版本字段version，int类型。

服务A调用服务B需要更新的时候，需要提前查询到version，然后作为参数传过去。

数据更新的时候将version + 1，接口如果发生重试的时候，version已经发生变更，那么也能保证幂等性。

# 高并发常见票据存储redis

异步请求获取ticket，此ticket是唯一并且一次性的，保存在页面中，每次发起支付请求都带上ticket，后端检查ticket，若支付成功则删除ticket，若支付失败则继续保留ticket。参数ticket的保存方案可以是MySQL或者Redis：

- 对于本身并发较低的场景，不会对MySQL服务造成压力，可以直接使用MySQL
    
- 并发较高的场景就要考虑Redis了，Redis这个key设置超时时间不用太长。